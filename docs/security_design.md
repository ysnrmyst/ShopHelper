# セキュリティ設計書

## 1. 概要

### 1.1 目的
- ユーザーデータの保護
- API通信のセキュリティ確保
- システム全体のセキュリティ強化

### 1.2 対象範囲
- Webアプリケーション
- API通信
- データ管理
- 外部API連携

## 2. セキュリティ要件

### 2.1 認証・認可
- **認証方式**: セッションIDベース（簡易認証）
- **認可**: 全ユーザーに同じ権限（認証不要）
- **セッション管理**: 
  - セッションID: UUID形式
  - 有効期限: 24時間
  - 自動延長: アクティビティ時

### 2.2 データ保護
- **個人情報**: 収集・保存しない
- **会話データ**: セッション中のみ保持
- **お気に入りデータ**: セッション中のみ保持
- **データ暗号化**: 不要（個人情報なし）

## 3. API セキュリティ

### 3.1 外部API連携
#### 楽天API
- **認証**: APIキー認証
- **暗号化**: HTTPS通信
- **レート制限**: 1秒間に1リクエスト
- **エラーハンドリング**: 429エラー時の待機

#### Amazon API
- **認証**: Access Key ID + Secret Access Key
- **暗号化**: HTTPS通信
- **レート制限**: 1秒間に1リクエスト
- **エラーハンドリング**: 429エラー時の待機

#### Google Custom Search API
- **認証**: APIキー認証
- **暗号化**: HTTPS通信
- **レート制限**: 1日100クエリ
- **エラーハンドリング**: 429エラー時の待機

### 3.2 内部API
- **認証**: 不要（同一システム内）
- **暗号化**: HTTPS通信
- **入力検証**: 必須

## 4. 通信暗号化

### 4.1 HTTPS/TLS
- **プロトコル**: TLS 1.3推奨
- **証明書**: Let's Encrypt（無料）
- **暗号スイート**: 強力な暗号のみ使用

### 4.2 データ転送
- **API通信**: HTTPS必須
- **WebSocket**: WSS（暗号化）
- **ファイル転送**: 不要

## 5. 入力検証・サニタイゼーション

### 5.1 ユーザー入力
```python
# 入力検証例
def validate_user_input(text: str) -> bool:
    # 文字数制限
    if len(text) > 1000:
        return False
    
    # 禁止文字チェック
    forbidden_chars = ['<script>', 'javascript:', 'onload=']
    for char in forbidden_chars:
        if char in text.lower():
            return False
    
    return True
```

### 5.2 API入力
- **パラメータ検証**: 型チェック必須
- **SQLインジェクション対策**: パラメータ化クエリ使用
- **XSS対策**: 出力時のエスケープ処理

## 6. エラー処理・ログ

### 6.1 エラーハンドリング
- **詳細エラー**: 本番環境では非表示
- **ログ出力**: エラー詳細をログに記録
- **ユーザー向け**: 一般的なエラーメッセージ

### 6.2 セキュリティログ
```python
# セキュリティログ例
def log_security_event(event_type: str, details: dict):
    log_entry = {
        'timestamp': datetime.now().isoformat(),
        'event_type': event_type,
        'details': details,
        'ip_address': request.remote_addr
    }
    # ログファイルに記録
    security_logger.warning(json.dumps(log_entry))
```

## 7. 監視・アラート

### 7.1 監視項目
- **API呼び出し頻度**: 異常な増加を検知
- **エラー率**: 5%以上でアラート
- **レスポンス時間**: 3秒以上でアラート
- **外部API制限**: レート制限接近時

### 7.2 アラート設定
```python
# 監視設定例
MONITORING_CONFIG = {
    'max_error_rate': 0.05,  # 5%
    'max_response_time': 3.0,  # 3秒
    'rate_limit_threshold': 0.8,  # 80%
    'alert_channels': ['email', 'slack']
}
```

## 8. 設定管理

### 8.1 環境変数
```bash
# 本番環境設定例
RAKUTEN_API_KEY=your_rakuten_api_key
AMAZON_ACCESS_KEY=your_amazon_access_key
AMAZON_SECRET_KEY=your_amazon_secret_key
GOOGLE_API_KEY=your_google_api_key
```

### 8.2 設定ファイル
- **開発環境**: `config/dev.py`
- **本番環境**: `config/prod.py`
- **テスト環境**: `config/test.py`

## 9. セキュリティテスト

### 9.1 テスト項目
- **入力検証テスト**: 不正入力の検証
- **API認証テスト**: 認証失敗時の動作
- **レート制限テスト**: 制限超過時の動作
- **エラーハンドリングテスト**: 各種エラー時の動作

### 9.2 テスト実行
```bash
# セキュリティテスト実行
python -m pytest tests/security/ -v
```

## 10. 運用・保守

### 10.1 定期チェック
- **APIキー更新**: 3ヶ月ごと
- **証明書更新**: 90日ごと
- **ログ監視**: 毎日
- **セキュリティアップデート**: 月次

### 10.2 インシデント対応
1. **検知**: 監視システムによる自動検知
2. **分析**: ログ分析による原因特定
3. **対応**: 影響範囲の特定と対策実施
4. **復旧**: システム復旧と動作確認
5. **報告**: 関係者への報告と再発防止

## 11. コンプライアンス

### 11.1 個人情報保護
- **GDPR**: 該当なし（個人情報収集なし）
- **個人情報保護法**: 該当なし（個人情報収集なし）

### 11.2 その他
- **Webアクセシビリティ**: WCAG 2.1準拠
- **セキュリティガイドライン**: OWASP Top 10対応

## 12. 今後の改善

### 12.1 短期（3ヶ月以内）
- [ ] セキュリティログの実装
- [ ] 監視システムの構築
- [ ] セキュリティテストの自動化

### 12.2 中期（6ヶ月以内）
- [ ] セキュリティ監査の実施
- [ ] 脆弱性スキャンの定期実行
- [ ] セキュリティトレーニングの実施

### 12.3 長期（1年以内）
- [ ] セキュリティ認証の取得検討
- [ ] セキュリティポリシーの策定
- [ ] インシデント対応体制の整備 