# エラー処理設計書

## 1. エラーの種類・分類

### 1.1 外部APIエラー
- **タイムアウトエラー**：外部APIからの応答が一定時間内にない
- **認証エラー**：APIキーが無効、期限切れ、権限不足
- **制限エラー**：API利用制限（1日あたりのリクエスト数制限など）
- **ネットワークエラー**：通信障害、DNS解決失敗
- **レスポンス形式エラー**：期待しないJSON形式、必須フィールド欠損

### 1.2 ユーザー入力エラー
- **空文字・不正な入力**：空のメッセージ、不正な文字列
- **区切り文字エラー**：区切り文字のみの入力
- **希望条件エラー**：数値以外の価格入力、不正な色指定

### 1.3 システム内部エラー
- **メモリ不足**：大量データ処理時のメモリ不足
- **データ不整合**：セッション情報の破損、状態遷移エラー
- **設定エラー**：環境変数未設定、設定ファイル不正

---

## 2. エラー処理方針

### 2.1 ユーザーへのエラーメッセージ設計
- **外部APIエラー**：「現在情報取得ができません。しばらく時間をおいて再度お試しください。」
- **ユーザー入力エラー**：「もう少し詳しく教えてください。」「正しい形式で入力してください。」
- **システム内部エラー**：「システムエラーが発生しました。ページを再読み込みしてください。」

### 2.2 フォールバック処理
- **楽天APIエラー時**：Amazon APIやGoogle Custom Search APIで代替検索
- **Vertex AIエラー時**：ルールベースのサジェスト生成に切り替え
- **全APIエラー時**：「商品情報の取得ができません。直接ECサイトで検索してください。」と案内

### 2.3 ログ出力・監視方針
- エラー発生時はログに詳細情報（エラー種別、発生時刻、影響範囲）を記録
- 外部APIエラーは監視システムでアラート通知
- ユーザー入力エラーは統計情報として記録（改善に活用）

---

## 3. エラーケース別の対応

### 3.1 楽天APIエラー対応
- **タイムアウト（30秒）**：リトライ1回、失敗時は他のAPIで代替
- **認証エラー**：管理者に通知、ユーザーには「一時的に利用できません」
- **制限エラー**：利用制限の確認、他のAPIで代替

### 3.2 Amazon APIエラー対応
- **署名エラー**：認証情報の確認、管理者に通知
- **利用制限**：他のAPIで代替検索
- **商品情報取得失敗**：楽天APIやGoogle検索で代替

### 3.3 Google Custom Search APIエラー対応
- **クォータ制限**：他の検索手段に切り替え
- **認証エラー**：APIキーの確認、管理者に通知

### 3.4 Vertex AIエラー対応
- **要約生成失敗**：ルールベースの処理に切り替え
- **サジェスト生成失敗**：固定のサジェスト候補を表示
- **認証エラー**：AI機能を無効化、基本機能のみ提供

### 3.5 ユーザー入力エラー対応
- **空文字入力**：「何か商品名や条件を教えてください。」
- **区切り文字のみ**：「具体的な機能や特徴を教えてください。」
- **不正な価格入力**：「価格は数字で入力してください（例：5000）。」

---

## 4. エラー回復・リトライ方針

### 4.1 リトライ条件
- **外部APIエラー**：タイムアウト、一時的な通信エラーのみリトライ
- **認証エラー、制限エラー**：リトライせず、即座にフォールバック処理
- **ユーザー入力エラー**：リトライせず、ユーザーに再入力を促す

### 4.2 リトライ設定
- **最大リトライ回数**：2回（初回含めて3回）
- **リトライ間隔**：指数バックオフ（1秒、2秒、4秒）
- **タイムアウト**：30秒

### 4.3 エラー回復フロー
1. エラー発生 → ログ記録
2. リトライ可能か判定
3. リトライ可能 → リトライ実行
4. リトライ不可 or リトライ失敗 → フォールバック処理
5. フォールバック失敗 → ユーザーにエラーメッセージ表示

---

## 5. エラー処理実装例

### 5.1 APIラッパーでのエラー処理
```python
def fetch_rakuten_items(keyword: str, hits: int = 10) -> list[dict]:
    try:
        response = requests.get(url, params=params, timeout=30)
        response.raise_for_status()
        return parse_response(response.json())
    except requests.Timeout:
        logger.error("楽天API タイムアウト")
        raise ApiTimeoutError("楽天APIからの応答がありません")
    except requests.HTTPError as e:
        if e.response.status_code == 401:
            logger.error("楽天API 認証エラー")
            raise ApiAuthError("認証に失敗しました")
        else:
            logger.error(f"楽天API HTTPエラー: {e}")
            raise ApiError("APIエラーが発生しました")
```

### 5.2 エージェントでのエラー処理
```python
def handle_user_input(self, text: str) -> str:
    try:
        if not text.strip():
            return "何か商品名や条件を教えてください。"
        
        # 正常処理
        return self.process_input(text)
    except Exception as e:
        logger.error(f"ユーザー入力処理エラー: {e}")
        return "エラーが発生しました。もう一度お試しください。"
``` 